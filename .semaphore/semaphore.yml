version: v1.0
name: Python Anywhere Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
auto_cancel:
  running:
    when: branch != 'master'
global_job_config:
  prologue:
    commands:
      - set -x
      - checkout
  # Connect secret to all jobs in the pipeline
  secrets:
    - name: env
blocks:
  - name: Install Frontend Dependencies
    dependencies: []
    task:
      prologue:
        commands:
          - nvm use
          - node --version
          - npm --version
      jobs:
        - name: npm install and cache
          commands:
            - cd frontend
            - cache restore node_modules
            - npm install
            # Persist downloaded packages for future jobs.
            - cache store node_modules node_modules
  - name: Install Backend Dependencies
    dependencies: []
    task:
      jobs:
        - name: pip
          commands:
            # Restore dependencies from cache. This command will not fail in
            # case of a cache miss. In case of a cache hit, pip can use it
            # to speed up the installation.
            # For more info on caching, see https://docs.semaphoreci.com/article/149-caching
            - cache restore
            # Install other python dependencies.
            # If not found in the cache, pip will download them.
            - sem-version python 3.9
            - pip download --cache-dir .pip_cache -r requirements.txt
            # Persist downloaded packages for future jobs.
            - cache store
        - name: private repositories
          commands:
            # Clone private repositories and cache them if not already cached
            - . .semaphore/private_repos.sh
        - name: usr
          commands:
            # Install gdal and spatialite and cache whole /usr directory
            - . .semaphore/install_gdal_and_spatialite.sh
  - name: Run Frontend Tests
    dependencies:
      - Install Frontend Dependencies
    task:
      prologue:
        commands_file: frontend_prologue.sh
      # This block executes code analysis with ESLint
      jobs:
        - name: ESLint
          commands:
            - npx eslint .
  - name: Run Backend Tests
      # This block executes code analysis with pylint and backend integration
      # tests.
    dependencies:
      - Install Backend Dependencies
    task:
      secrets:
        - name: private-repo
      prologue:
        commands_file: backend_prologue.sh
      jobs:
        - name: Pylint
          commands:
            - pylint python_anywhere --load-plugins=pylint_django
        - name: Integration tests
          commands:
            - python manage.py test
  - name: Run E2E Tests
      # This block executes code analysis with pylint and backend integration
      # tests.
    dependencies:
      - Install Frontend Dependencies
      - Install Backend Dependencies
    task:
      secrets:
        - name: private-repo
      prologue:
        commands_file: e2e_prologue.sh
      jobs:
        - name: E2E Tests
          commands:
            - python manage.py runserver &
            - cd frontend || exit
            - npm update
            - FILE_TO_WATCH=watchfile.out
            - SEARCH_PATTERN='DONE'
            - npm run serve > ${FILE_TO_WATCH} &
            - tail -f -n0 ${FILE_TO_WATCH} | grep -qe "${SEARCH_PATTERN}"
            - npx cypress run
promotions:
  - name: Deploy
    pipeline_file: deploy.yml
    auto_promote:
      when: branch = 'master' AND result = 'passed'
