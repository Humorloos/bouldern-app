version: v1.0
name: Deploy Django to PythonAnywhere
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: 'docker.io/humorloos/boulder-holder:latest'
blocks:
  - name: Deploy
    task:
      secrets:
        - name: pythonanywhere-credentials
        - name: env_production
      env_vars:
        - name: SSH_USER
          value: Humorloos
      jobs:
        - name: Deploy to PythonAnywhere
          commands:
            - checkout
            - chmod 0600 ~/.ssh/id_rsa_pa
            - ssh-keyscan -H ssh.pythonanywhere.com >> ~/.ssh/known_hosts
            - ssh-add ~/.ssh/id_rsa_pa
            - cd ~
            - sftp ${SSH_USER}@ssh.pythonanywhere.com <<< $'put bouldern-app/deploy.sh deploy.sh\n put .env_production .env'
            - ssh ${SSH_USER}@ssh.pythonanywhere.com bash deploy.sh ${SEMAPHORE_GIT_PR_BRANCH-master}
